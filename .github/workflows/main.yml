# This workflow builds a Theos-based iOS application.
#
# It includes steps to:
# 1. Install Theos dependencies (ldid, xz) and an updated 'make' for parallel builds.
# 2. Clone Theos itself and set the $THEOS environment variable.
# 3. Override the 'ARCHS' variable to build only for modern 64-bit architectures.

name: Build iOS App

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          ls -l /Applications/ | grep Xcode
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version
          swift -version

      # --- Install Theos & Build Dependencies ---
      - name: Install Dependencies
        run: |
          echo "Installing Theos dependencies (ldid, xz) and gnu-make (for parallel builds)..."
          brew install ldid xz make

      - name: Clone Theos Repository
        run: |
          echo "Cloning Theos..."
          git clone --recursive https://github.com/theos/theos.git $GITHUB_WORKSPACE/theos

      - name: Set THEOS Environment Variable
        run: |
          echo "Setting THEOS environment variable..."
          echo "THEOS=$GITHUB_WORKSPACE/theos" >> $GITHUB_ENV
      # --- End Install Theos ---

      # --- Main Build Step ---
      - name: Run make
        run: |
          # We use 'gmake' (from brew) for parallel building.
          # We override ARCHS to build only for modern 64-bit architectures,
          # as armv7 is not supported by the Xcode 16.4 SDK.
          gmake ARCHS="arm64e arm64"

      # --- Upload Artifacts ---
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-App-Build
          # Theos projects often output to a './packages' directory.
          # Adjust if your project is different.
          path: |
            packages/*.ipa
          retention-days: 7
          # Optional: tell upload-artifact to not fail if no files are found
          # if-no-files-found: warn 


