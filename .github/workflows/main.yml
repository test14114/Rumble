# This workflow builds a Theos-based iOS application.
#
# It includes steps to:
# 1. Check out the repository AND all its submodules.
# 2. Install Theos dependencies (ldid, xz), gnu-make, and libyaml.
# 3. Clone Theos itself and set the $THEOS environment variable.
# 4. Override the 'ARCHS' variable to build only for modern 64-bit architectures.

name: Build iOS App

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          # ** THIS IS THE FIX **
          # Recursively check out all submodules (like RumbleExt/yaml)
          submodules: 'recursive'

      - name: Select Xcode version
        run: |
          ls -l /Applications/ | grep Xcode
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version
          swift -version

      # --- Install Theos & Build Dependencies ---
      - name: Install Dependencies
        run: |
          echo "Installing Theos dependencies (ldid, xz), gnu-make, and libyaml..."
          # Added libyaml as a dependency for the RumbleExt subproject
          brew install ldid xz make libyaml

      - name: Clone Theos Repository
        run: |
          echo "Cloning Theos..."
          git clone --recursive https://github.com/theos/theos.git $GITHUB_WORKSPACE/theos

      - name: Set THEOS Environment Variable
        run: |
          echo "Setting THEOS environment variable..."
          echo "THEOS=$GITHUB_WORKSPACE/theos" >> $GITHUB_ENV
      # --- End Install Theos ---

      # --- Main Build Step ---
      - name: Run make
        run: |
          # Use gmake for parallel building
          # Override ARCHS to skip armv7
          gmake ARCHS="arm64e arm64"

      # --- Upload Artifacts ---
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-App-Build
          path: |
            packages/*.ipa
          retention-days: 7
          if-no-files-found: warn # Don't fail the workflow if the .ipa isn't found


