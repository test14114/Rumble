# This workflow builds a Theos-based iOS application.
#
# It includes steps to install Theos dependencies, clone Theos itself,
# and set the $THEOS environment variable before running 'make'.

name: Build iOS App

on:
  # Trigger the build on push or pull request to the main/master branch
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  
  # Allow you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    # iOS apps must be built on macOS
    runs-on: macos-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          # List available Xcode versions on the runner
          ls -l /Applications/ | grep Xcode
          
          # Select a specific Xcode version from the logs.
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          
          # Verify the selected version
          xcodebuild -version
          swift -version

      # --- Install Theos ---
      - name: Install Theos Dependencies
        run: |
          echo "Installing Theos dependencies (ldid, xz)..."
          brew install ldid xz

      - name: Clone Theos Repository
        run: |
          echo "Cloning Theos..."
          # Clone Theos into a directory within the workspace
          # We use --recursive to fetch all its submodules
          git clone --recursive https://github.com/theos/theos.git $GITHUB_WORKSPACE/theos

      - name: Set THEOS Environment Variable
        run: |
          echo "Setting THEOS environment variable..."
          # Set the $THEOS var for all subsequent steps in this job
          echo "THEOS=$GITHUB_WORKSPACE/theos" >> $GITHUB_ENV
      # --- End Install Theos ---


      # --- Optional: Install Dependencies (SPM/CocoaPods) ---
      # If your project also uses other dependencies, uncomment as needed
      
      # - name: Cache SwiftPM dependencies
      #   uses: actions/cache@vv4
      #   with:
      #     path: .build
      #     key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
      #     restore-keys: |
      #       ${{ runner.os }}-spm-
      
      # - name: Fetch SwiftPM dependencies
      #   run: swift package resolve


      # --- Main Build Step ---
      - name: Run make
        # The $THEOS environment variable set above will be
        # automatically used by 'make'
        run: make

      # --- Upload Artifacts ---
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-App-Build
          # ** IMPORTANT: YOU MUST UPDATE THIS PATH! **
          # Point this to the output directory and file from your Makefile.
          # Theos projects often output to a './packages' directory.
          path: |
            packages/*.ipa
            # build/Release-iphoneos/*.app
          retention-days: 7


